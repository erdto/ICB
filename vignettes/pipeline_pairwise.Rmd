---
title: "pipeline_pairwise"
author: "Tore Erdmann"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

The `pipeline_pairwise` function is an exploratory tool to analyze group differences for example for a collection of metabolites (whose data is stored as columns of a data.frame). It essentially loops through for all Metabolites in `data` and performs pairwise t-tests for all groups defined by a grouping variable and uses resampling to control for false positives.

In the following, we will go through an example call. The example data set consists of metabolite data for two illness condition and control individuals.

### Mandatory inputs

We start by simulating metabolite data for which group differences are to be tested, the covariables that are to be controlled for and the grouping variable: in this case "N" for control group, and different illness conditions: FL (Follicular Lymphoma), DLBCL (?)
```{r}
metdata <- matrix(rnorm(20 * 100, sd = 5), nrow = 100)
groups <- factor(sample(c("N", "FL", "DLBCL"), size = 100, replace = TRUE))
```

### A simple Function call

The function prints an excel file and several pdfs with the prefix
"Example_pairwise" into the working directory
```{r, eval=FALSE}
pipeline_pairwise(data = metdata, groups = groups, vargroups = vargroups,
                  compname = "Example_pairwise", covars = covariates)
```



### Optional inputs

#### Covariates
We can controll for several covariates.
```{r, eval=FALSE}
covariates <- data.frame(C_Sex = factor(sample(0:1, size = 100, replace = TRUE)),
                         C_Age_at_diagnosis = as.numeric(sample(20:60, 100, replace = TRUE)))

pipeline_pairwise(data = metdata, groups = groups, 
                  compname = "Example_pairwise",
                  vargroups = vargroups,
                  covars = covariates)
```

#### Pathway groupings
Vargroups are the groups of metabolites that are to be tested together
after all metabolites were tested individually. (Metabolites that can be grouped, 
for example into "Amino Acids" or "Glutamate Metabolism"). Aggregated z-scores are computed for the groups of metabolites 
and these are used as data for the difference tests.
```{r}
vargroups <- sample(c("Xenobiotics", "Amino Acid", 
                      "Lipid", "Carbohydrate", "Nucleotide", 
                      "Energy", "Cofactors and Vitamins", 
                      "Peptide", NA_character_), 
                    size = 100, replace = TRUE)
```

The next call will also incorporate the vargroups, so after the individual metabolites were tested for group differences, they are tested in groups using aggregated z-scores. Now we also want to use 4 CPU cores to speed things up.

The `set_boxplot_args` function is used to specify the options for the boxplots. Here we want them orderd by p-value and we fix the y-axis for all plots.
Again, you can check what arguments there are for the boxplots with `?set_boxplot_args`.

```{r, eval=FALSE}

pipeline_pairwise(data = metdata, groups = groups, compname = "Example_pairwise", 
                  covars = covariates, vargroups = vargroups, ncores = 4,
                  boxplot_args = set_boxplot_args(sort_boxplots = TRUE,
                                                  ylim = c(0, 5))

```